<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Keuangan Pribadi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #333;
            font-size: 28px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            margin-right: 5px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            padding: 25px;
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card-income {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .card-expense {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .card-balance {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .card-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
        }

        .form-container {
            background: #f9fafb;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 10px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-box {
            background: #f9fafb;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e5e7eb;
        }

        .chart-box h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
        }

        .transactions {
            background: #f9fafb;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e5e7eb;
        }

        .transactions h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .transaction-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .transaction-item:hover {
            transform: translateX(5px);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-category {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .transaction-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .transaction-date {
            color: #999;
            font-size: 12px;
        }

        .transaction-amount {
            font-size: 20px;
            font-weight: bold;
            margin-right: 15px;
        }

        .amount-income {
            color: #10b981;
        }

        .amount-expense {
            color: #ef4444;
        }

        .transaction-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .storage-status {
            background: #dcfce7;
            color: #166534;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .transaction-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="storage-status">
            üíæ Data otomatis tersimpan di browser Anda
        </div>

        <div class="header">
            <h1>üí∞ Aplikasi Keuangan Pribadi</h1>
            <button class="btn btn-primary" onclick="toggleForm()">‚ûï Tambah Transaksi</button>
        </div>

        <div class="summary-cards">
            <div class="card card-income">
                <div class="card-label">Pemasukan</div>
                <div class="card-value" id="totalIncome">Rp 0</div>
            </div>
            <div class="card card-expense">
                <div class="card-label">Pengeluaran</div>
                <div class="card-value" id="totalExpense">Rp 0</div>
            </div>
            <div class="card card-balance">
                <div class="card-label">Saldo</div>
                <div class="card-value" id="balance">Rp 0</div>
            </div>
        </div>

        <div class="form-container" id="formContainer">
            <h2 style="margin-bottom: 20px; color: #333;" id="formTitle">Transaksi Baru</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Tipe</label>
                    <select id="type" onchange="updateCategories()">
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="category"></select>
                </div>
                <div class="form-group">
                    <label>Jumlah (Rp)</label>
                    <input type="number" id="amount" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>Tanggal</label>
                    <input type="date" id="date">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Deskripsi</label>
                    <input type="text" id="description" placeholder="Catatan tambahan (opsional)">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveTransactionForm()">Simpan</button>
                <button class="btn btn-secondary" onclick="cancelForm()">Batal</button>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <h2>Pengeluaran per Kategori</h2>
                <canvas id="pieChart"></canvas>
            </div>
            <div class="chart-box">
                <h2>Tren Bulanan</h2>
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div class="transactions">
            <h2>
                <span>Riwayat Transaksi</span>
                <button class="btn btn-warning" onclick="resetAllData()">üóëÔ∏è Reset Semua Data</button>
            </h2>
            <div id="transactionList"></div>
        </div>
    </div>

    <script>
        const categories = {
            income: ['Gaji', 'Freelance', 'Investasi', 'Lainnya'],
            expense: ['Makanan', 'Transport', 'Belanja', 'Tagihan', 'Hiburan', 'Kesehatan', 'Pendidikan', 'Lainnya']
        };

        let transactions = [];
        let pieChart, barChart;
        let editingTransactionId = null; // Track if we're editing

        // Database functions menggunakan IndexedDB
        const DB_NAME = 'FinanceAppDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'transactions';
        let db;

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        objectStore.createIndex('date', 'date', { unique: false });
                        objectStore.createIndex('type', 'type', { unique: false });
                    }
                };
            });
        }

        function saveTransaction(transaction) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.add(transaction);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function loadAllTransactions() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteTransactionFromDB(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function clearAllTransactions() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function init() {
            try {
                await openDatabase();
                transactions = await loadAllTransactions();
                
                // Sort by date descending
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                document.getElementById('date').valueAsDate = new Date();
                updateCategories();
                updateDashboard();
                initCharts();
            } catch (error) {
                console.error('Error initializing database:', error);
                alert('Terjadi kesalahan saat membuka database');
            }
        }

        function toggleForm() {
            const form = document.getElementById('formContainer');
            form.classList.toggle('active');
            if (!form.classList.contains('active')) {
                cancelForm();
            }
        }

        function cancelForm() {
            editingTransactionId = null;
            document.getElementById('formTitle').textContent = 'Transaksi Baru';
            document.getElementById('type').value = 'expense';
            document.getElementById('category').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            document.getElementById('date').valueAsDate = new Date();
            updateCategories();
            document.getElementById('formContainer').classList.remove('active');
        }

        function updateCategories() {
            const type = document.getElementById('type').value;
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
            
            categories[type].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        async function addTransaction() {
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;

            if (!category || !amount || amount <= 0) {
                alert('Mohon isi semua field yang diperlukan!');
                return;
            }

            const newTransaction = {
                id: Date.now(),
                type,
                category,
                amount,
                description,
                date
            };

            try {
                await saveTransaction(newTransaction);
                transactions.unshift(newTransaction);
                
                cancelForm();
                updateDashboard();
                updateCharts();
                
                showNotification('‚úÖ Transaksi berhasil disimpan!');
            } catch (error) {
                console.error('Error saving transaction:', error);
                alert('Gagal menyimpan transaksi');
            }
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            editingTransactionId = id;
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Edit Transaksi';
            document.getElementById('type').value = transaction.type;
            updateCategories();
            document.getElementById('category').value = transaction.category;
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('description').value = transaction.description;
            document.getElementById('date').value = transaction.date;
            
            document.getElementById('formContainer').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateTransaction() {
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;

            if (!category || !amount || amount <= 0) {
                alert('Mohon isi semua field yang diperlukan!');
                return;
            }

            const updatedTransaction = {
                id: editingTransactionId,
                type,
                category,
                amount,
                description,
                date
            };

            try {
                // Delete old and save new
                await deleteTransactionFromDB(editingTransactionId);
                await saveTransaction(updatedTransaction);
                
                // Update in memory
                const index = transactions.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) {
                    transactions[index] = updatedTransaction;
                }
                
                cancelForm();
                updateDashboard();
                updateCharts();
                
                showNotification('‚úÖ Transaksi berhasil diupdate!');
            } catch (error) {
                console.error('Error updating transaction:', error);
                alert('Gagal mengupdate transaksi');
            }
        }

        function saveTransactionForm() {
            if (editingTransactionId) {
                updateTransaction();
            } else {
                addTransaction();
            }
        }

        async function deleteTransaction(id) {
            if (confirm('Hapus transaksi ini?')) {
                try {
                    await deleteTransactionFromDB(id);
                    transactions = transactions.filter(t => t.id !== id);
                    updateDashboard();
                    updateCharts();
                    showNotification('üóëÔ∏è Transaksi berhasil dihapus!');
                } catch (error) {
                    console.error('Error deleting transaction:', error);
                    alert('Gagal menghapus transaksi');
                }
            }
        }

        async function resetAllData() {
            if (confirm('‚ö†Ô∏è PERHATIAN!\n\nAnda yakin ingin menghapus SEMUA data transaksi?\nTindakan ini tidak dapat dibatalkan!')) {
                if (confirm('Konfirmasi sekali lagi: Hapus semua data?')) {
                    try {
                        await clearAllTransactions();
                        transactions = [];
                        updateDashboard();
                        updateCharts();
                        showNotification('üóëÔ∏è Semua data berhasil dihapus!');
                    } catch (error) {
                        console.error('Error clearing data:', error);
                        alert('Gagal menghapus data');
                    }
                }
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateDashboard() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expense);
            document.getElementById('balance').textContent = formatCurrency(balance);

            updateTransactionList();
        }

        function updateTransactionList() {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';

            if (transactions.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Belum ada transaksi. Klik "Tambah Transaksi" untuk memulai!</p>';
                return;
            }

            transactions.forEach(t => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                
                const dateObj = new Date(t.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                item.innerHTML = `
                    <div class="transaction-info">
                        <div class="transaction-category">${t.category}</div>
                        <div class="transaction-desc">${t.description || '-'}</div>
                        <div class="transaction-date">üìÖ ${formattedDate}</div>
                    </div>
                    <div class="transaction-actions">
                        <div class="transaction-amount ${t.type === 'income' ? 'amount-income' : 'amount-expense'}">
                            ${t.type === 'income' ? '+' : '-'} ${formatCurrency(t.amount)}
                        </div>
                        <button class="btn btn-edit" onclick="editTransaction(${t.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteTransaction(${t.id})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function initCharts() {
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', 
                            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            const barCtx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: [],
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Pengeluaran',
                            data: [],
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            updateCharts();
        }

        function updateCharts() {
            // Update Pie Chart
            const expenseByCategory = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
            });

            pieChart.data.labels = Object.keys(expenseByCategory);
            pieChart.data.datasets[0].data = Object.values(expenseByCategory);
            pieChart.update();

            // Update Bar Chart
            const monthlyData = {};
            transactions.forEach(t => {
                const month = t.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expense: 0 };
                }
                if (t.type === 'income') {
                    monthlyData[month].income += t.amount;
                } else {
                    monthlyData[month].expense += t.amount;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            barChart.data.labels = sortedMonths;
            barChart.data.datasets[0].data = sortedMonths.map(m => monthlyData[m].income);
            barChart.data.datasets[1].data = sortedMonths.map(m => monthlyData[m].expense);
            barChart.update();
        }

        // Add CSS animation for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        init();
    </script>
</body>
</html>